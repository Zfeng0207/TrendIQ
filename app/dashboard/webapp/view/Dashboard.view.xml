<mvc:View
    controllerName="beautyleads.dashboard.controller.Dashboard"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    xmlns:f="sap.f"
    xmlns:viz="sap.viz.ui5.controls"
    xmlns:vizData="sap.viz.ui5.data"
    xmlns:vizFeeds="sap.viz.ui5.controls.common.feeds"
    xmlns:mc="sap.suite.ui.microchart"
    height="100%">

    <Page
        id="dashboardPage"
        title="{i18n>appTitle}"
        showNavButton="false"
        enableScrolling="true"
        class="sapUiResponsiveContentPadding dashboardPage">

        <!-- Header Toolbar -->
        <customHeader>
            <Bar>
                <contentLeft>
                    <Title text="{i18n>appTitle}" class="dashboardTitle"/>
                </contentLeft>
                <contentRight>
                    <Button
                        icon="sap-icon://refresh"
                        tooltip="{i18n>refresh}"
                        press=".onRefresh"
                        type="Transparent"/>
                    <Text text="{i18n>lastUpdated}: " class="sapUiTinyMarginEnd"/>
                    <Text id="lastUpdatedTime" text="{kpi>/lastUpdated}" class="lastUpdatedText"/>
                </contentRight>
            </Bar>
        </customHeader>

        <content>
            <VBox class="dashboardContent">

                <!-- ========================================== -->
                <!-- SECTION 1: KPI TILES - 6 tiles in single row -->
                <!-- Using Grid with XL2 L4 M6 S12 for proper alignment -->
                <!-- ========================================== -->
                <l:Grid
                    id="kpiTileGrid"
                    class="kpiTileGrid"
                    defaultSpan="XL2 L4 M6 S12"
                    hSpacing="1"
                    vSpacing="1">

                    <!-- Hot Leads Tile -->
                    <GenericTile
                        id="tileHotLeads"
                        header="{i18n>kpiHotLeads}"
                        subheader="{i18n>kpiHotLeadsSubtitle}"
                        class="kpiTile kpiTileOrange"
                        press=".onTilePress"
                        frameType="OneByOne">
                        <TileContent>
                            <NumericContent
                                value="{kpi>/leadKPIs/hotLeads}"
                                scale=""
                                valueColor="Good"
                                indicator="Up"
                                withMargin="false"/>
                        </TileContent>
                    </GenericTile>

                    <!-- Pipeline Value Tile -->
                    <GenericTile
                        id="tilePipelineValue"
                        header="{i18n>kpiPipelineValue}"
                        subheader="{i18n>kpiPipelineValueSubtitle}"
                        class="kpiTile kpiTileBlue"
                        press=".onTilePress"
                        frameType="OneByOne">
                        <TileContent>
                            <NumericContent
                                value="{kpi>/opportunityKPIs/totalPipelineValue}"
                                scale="RM"
                                valueColor="Neutral"
                                truncateValueTo="5"
                                withMargin="false"/>
                        </TileContent>
                    </GenericTile>

                    <!-- Closing This Month Tile -->
                    <GenericTile
                        id="tileClosingThisMonth"
                        header="{i18n>kpiClosingThisMonth}"
                        subheader="{i18n>kpiClosingThisMonthSubtitle}"
                        class="kpiTile kpiTileGreen"
                        press=".onTilePress"
                        frameType="OneByOne">
                        <TileContent>
                            <NumericContent
                                value="{kpi>/closingThisMonth}"
                                valueColor="Good"
                                withMargin="false"/>
                        </TileContent>
                    </GenericTile>

                    <!-- At Risk Accounts Tile -->
                    <GenericTile
                        id="tileAtRisk"
                        header="{i18n>kpiAtRiskAccounts}"
                        subheader="{i18n>kpiAtRiskAccountsSubtitle}"
                        class="kpiTile kpiTileRed"
                        press=".onTilePress"
                        frameType="OneByOne">
                        <TileContent>
                            <NumericContent
                                value="{kpi>/accountKPIs/atRiskCount}"
                                valueColor="Critical"
                                indicator="Down"
                                withMargin="false"/>
                        </TileContent>
                    </GenericTile>

                    <!-- Avg AI Win Score Tile -->
                    <GenericTile
                        id="tileAvgWinScore"
                        header="{i18n>kpiAvgWinScore}"
                        subheader="{i18n>kpiAvgWinScoreSubtitle}"
                        class="kpiTile kpiTilePurple"
                        press=".onTilePress"
                        frameType="OneByOne">
                        <TileContent>
                            <NumericContent
                                value="{kpi>/opportunityKPIs/avgWinScore}"
                                scale="%"
                                valueColor="Neutral"
                                withMargin="false"/>
                        </TileContent>
                    </GenericTile>

                    <!-- Open Tasks Tile -->
                    <GenericTile
                        id="tileOpenTasks"
                        header="{i18n>kpiOpenTasks}"
                        subheader="{i18n>kpiOpenTasksSubtitle}"
                        class="kpiTile kpiTileTeal"
                        press=".onTilePress"
                        frameType="OneByOne">
                        <TileContent>
                            <NumericContent
                                value="{kpi>/activityKPIs/plannedActivities}"
                                valueColor="Neutral"
                                withMargin="false"/>
                        </TileContent>
                    </GenericTile>

                </l:Grid>

                <!-- ========================================== -->
                <!-- SECTION 2: PIPELINE CHARTS + ACTIVITY TIMELINE -->
                <!-- Left: Pipeline Charts (8 cols), Right: Activity (4 cols) -->
                <!-- ========================================== -->
                <l:Grid
                    id="pipelineActivitySection"
                    class="pipelineActivitySection"
                    defaultSpan="XL4 L6 M12 S12"
                    hSpacing="1"
                    vSpacing="1">

                    <!-- Lead Pipeline Chart -->
                    <f:Card class="dashboardCard chartCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>leadPipelineTitle}"
                                subtitle="{i18n>leadPipelineSubtitle}"
                                iconSrc="sap-icon://lead"/>
                        </f:header>
                        <f:content>
                            <viz:VizFrame
                                id="leadPipelineChart"
                                vizType="bar"
                                height="280px"
                                width="100%"
                                uiConfig="{applicationSet:'fiori'}">
                                <viz:dataset>
                                    <vizData:FlattenedDataset data="{/LeadsByStatus}">
                                        <vizData:dimensions>
                                            <vizData:DimensionDefinition name="Status" value="{status}"/>
                                        </vizData:dimensions>
                                        <vizData:measures>
                                            <vizData:MeasureDefinition name="Leads" value="{count}"/>
                                        </vizData:measures>
                                    </vizData:FlattenedDataset>
                                </viz:dataset>
                                <viz:feeds>
                                    <vizFeeds:FeedItem uid="valueAxis" type="Measure" values="Leads"/>
                                    <vizFeeds:FeedItem uid="categoryAxis" type="Dimension" values="Status"/>
                                </viz:feeds>
                            </viz:VizFrame>
                        </f:content>
                    </f:Card>

                    <!-- Opportunity Pipeline Chart -->
                    <f:Card class="dashboardCard chartCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>opportunityPipelineTitle}"
                                subtitle="{i18n>opportunityPipelineSubtitle}"
                                iconSrc="sap-icon://opportunity"/>
                        </f:header>
                        <f:content>
                            <viz:VizFrame
                                id="opportunityPipelineChart"
                                vizType="bar"
                                height="280px"
                                width="100%"
                                uiConfig="{applicationSet:'fiori'}">
                                <viz:dataset>
                                    <vizData:FlattenedDataset data="{/OpportunitiesByStage}">
                                        <vizData:dimensions>
                                            <vizData:DimensionDefinition name="Stage" value="{stage}"/>
                                        </vizData:dimensions>
                                        <vizData:measures>
                                            <vizData:MeasureDefinition name="Value (RM)" value="{totalValue}"/>
                                        </vizData:measures>
                                    </vizData:FlattenedDataset>
                                </viz:dataset>
                                <viz:feeds>
                                    <vizFeeds:FeedItem uid="valueAxis" type="Measure" values="Value (RM)"/>
                                    <vizFeeds:FeedItem uid="categoryAxis" type="Dimension" values="Stage"/>
                                </viz:feeds>
                            </viz:VizFrame>
                        </f:content>
                    </f:Card>

                    <!-- Recent Activities Timeline -->
                    <f:Card class="dashboardCard activityCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>recentActivitiesTitle}"
                                subtitle="{i18n>recentActivitiesSubtitle}"
                                iconSrc="sap-icon://activity-items"/>
                        </f:header>
                        <f:content>
                            <List
                                id="recentActivitiesList"
                                items="{path: '/RecentActivities', length: 6}"
                                mode="None"
                                showSeparators="Inner">
                                <FeedListItem
                                    sender="{assignedToName}"
                                    icon="{= ${activityType} === 'Call' ? 'sap-icon://call' : ${activityType} === 'Email' ? 'sap-icon://email' : ${activityType} === 'Meeting' ? 'sap-icon://meeting-room' : 'sap-icon://task'}"
                                    text="{subject}"
                                    info="{activityType}"
                                    timestamp="{path: 'startDateTime', formatter: '.formatDateTime'}"
                                    senderPress=".onActivitySenderPress"
                                    iconPress=".onActivityPress">
                                </FeedListItem>
                            </List>
                        </f:content>
                    </f:Card>

                </l:Grid>

                <!-- ========================================== -->
                <!-- SECTION 3: AI INSIGHTS CARDS (3 columns) -->
                <!-- ========================================== -->
                <l:Grid
                    id="aiInsightsSection"
                    class="aiInsightsSection"
                    defaultSpan="XL4 L4 M6 S12"
                    hSpacing="1"
                    vSpacing="1">

                    <!-- Card 3A: Top Leads by AI Score -->
                    <f:Card class="dashboardCard aiCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>aiLeadScoresTitle}"
                                subtitle="{i18n>aiLeadScoresSubtitle}"
                                iconSrc="sap-icon://lead"
                                statusText="{kpi>/leadKPIs/totalLeads} total"/>
                        </f:header>
                        <f:content>
                            <VBox>
                                <List
                                    id="topLeadsList"
                                    items="{path: '/TopLeadsByAI', length: 5}"
                                    mode="None"
                                    showSeparators="Inner">
                                    <ObjectListItem
                                        title="{outletName}"
                                        number="{aiScore}"
                                        numberUnit="AI"
                                        numberState="{= ${aiScore} >= 80 ? 'Success' : ${aiScore} >= 60 ? 'Warning' : 'Error'}"
                                        type="Active"
                                        press=".onLeadPress">
                                        <firstStatus>
                                            <ObjectStatus
                                                text="{leadQuality}"
                                                state="{= ${leadQuality} === 'Hot' ? 'Success' : ${leadQuality} === 'Warm' ? 'Warning' : 'None'}"/>
                                        </firstStatus>
                                        <attributes>
                                            <ObjectAttribute text="{brandToPitch}"/>
                                        </attributes>
                                    </ObjectListItem>
                                </List>
                                <OverflowToolbar class="cardFooterToolbar">
                                    <ToolbarSpacer/>
                                    <Button text="{i18n>viewAll}" type="Transparent" press=".onViewAllLeads"/>
                                </OverflowToolbar>
                            </VBox>
                        </f:content>
                    </f:Card>

                    <!-- Card 3B: Account Health Distribution -->
                    <f:Card class="dashboardCard aiCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>aiAccountHealthTitle}"
                                subtitle="{i18n>aiAccountHealthSubtitle}"
                                iconSrc="sap-icon://customer"
                                statusText="{kpi>/accountKPIs/totalAccounts} accounts"/>
                        </f:header>
                        <f:content>
                            <VBox class="healthDistributionBox">
                                <!-- Health Distribution with Donut-style indicators -->
                                <HBox justifyContent="SpaceAround" class="healthGauges sapUiSmallMarginTop sapUiSmallMarginBottom">
                                    <VBox alignItems="Center" class="healthGaugeItem">
                                        <mc:RadialMicroChart
                                            size="M"
                                            percentage="{kpi>/healthDistribution/healthyPercent}"
                                            valueColor="Good"/>
                                        <Text text="{kpi>/healthDistribution/healthy}" class="gaugeValue"/>
                                        <Label text="Healthy" class="gaugeLabel healthyLabel"/>
                                    </VBox>
                                    <VBox alignItems="Center" class="healthGaugeItem">
                                        <mc:RadialMicroChart
                                            size="M"
                                            percentage="{kpi>/healthDistribution/monitorPercent}"
                                            valueColor="Critical"/>
                                        <Text text="{kpi>/healthDistribution/monitor}" class="gaugeValue"/>
                                        <Label text="Monitor" class="gaugeLabel monitorLabel"/>
                                    </VBox>
                                    <VBox alignItems="Center" class="healthGaugeItem">
                                        <mc:RadialMicroChart
                                            size="M"
                                            percentage="{kpi>/healthDistribution/atRiskPercent}"
                                            valueColor="Error"/>
                                        <Text text="{kpi>/healthDistribution/atRisk}" class="gaugeValue"/>
                                        <Label text="At Risk" class="gaugeLabel atRiskLabel"/>
                                    </VBox>
                                </HBox>

                                <!-- At Risk Accounts List -->
                                <List
                                    id="atRiskAccountsList"
                                    items="{path: '/AtRiskAccounts', length: 3}"
                                    headerText="Needs Attention"
                                    mode="None"
                                    showSeparators="Inner">
                                    <StandardListItem
                                        title="{accountName}"
                                        description="{accountType}"
                                        info="Health: {healthScore}"
                                        infoState="{= ${healthScore} >= 50 ? 'Warning' : 'Error'}"
                                        type="Active"
                                        press=".onAccountPress"/>
                                </List>
                                <OverflowToolbar class="cardFooterToolbar">
                                    <ToolbarSpacer/>
                                    <Button text="{i18n>viewAll}" type="Transparent" press=".onViewAllAccounts"/>
                                </OverflowToolbar>
                            </VBox>
                        </f:content>
                    </f:Card>

                    <!-- Card 3C: Top Opportunities by Win Score -->
                    <f:Card class="dashboardCard aiCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>aiOpportunityPredictionsTitle}"
                                subtitle="{i18n>aiOpportunityPredictionsSubtitle}"
                                iconSrc="sap-icon://opportunity"
                                statusText="RM {kpi>/opportunityKPIs/totalPipelineValue}"/>
                        </f:header>
                        <f:content>
                            <VBox>
                                <List
                                    id="topOpportunitiesList"
                                    items="{path: '/TopOpportunitiesByWinScore', length: 5}"
                                    mode="None"
                                    showSeparators="Inner">
                                    <ObjectListItem
                                        title="{name}"
                                        number="{aiWinScore}"
                                        numberUnit="%"
                                        numberState="{= ${aiWinScore} >= 80 ? 'Success' : ${aiWinScore} >= 60 ? 'Warning' : 'Error'}"
                                        type="Active"
                                        press=".onOpportunityPress">
                                        <firstStatus>
                                            <ObjectStatus
                                                text="{stage}"
                                                inverted="true"
                                                state="{= ${stage} === 'Proposal' || ${stage} === 'Negotiation' ? 'Success' : 'Information'}"/>
                                        </firstStatus>
                                        <attributes>
                                            <ObjectAttribute text="RM {expectedRevenue}"/>
                                        </attributes>
                                    </ObjectListItem>
                                </List>
                                <OverflowToolbar class="cardFooterToolbar">
                                    <ToolbarSpacer/>
                                    <Button text="{i18n>viewAll}" type="Transparent" press=".onViewAllOpportunities"/>
                                </OverflowToolbar>
                            </VBox>
                        </f:content>
                    </f:Card>

                </l:Grid>

                <!-- ========================================== -->
                <!-- SECTION 4: TASKS, PRODUCTS & CAMPAIGNS (3 columns) -->
                <!-- ========================================== -->
                <l:Grid
                    id="bottomSection"
                    class="bottomSection"
                    defaultSpan="XL4 L4 M6 S12"
                    hSpacing="1"
                    vSpacing="1">

                    <!-- Upcoming Tasks -->
                    <f:Card class="dashboardCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>upcomingTasksTitle}"
                                subtitle="{i18n>upcomingTasksSubtitle}"
                                iconSrc="sap-icon://task"/>
                        </f:header>
                        <f:content>
                            <List
                                id="upcomingTasksList"
                                items="{path: '/UpcomingTasks', length: 5}"
                                mode="None"
                                showSeparators="Inner">
                                <ObjectListItem
                                    title="{subject}"
                                    number="{path: 'dueDate', formatter: '.formatDate'}"
                                    numberUnit="Due"
                                    numberState="{= ${priority} === 'High' ? 'Error' : 'None'}"
                                    type="Active"
                                    press=".onTaskPress">
                                    <firstStatus>
                                        <ObjectStatus
                                            text="{priority}"
                                            state="{= ${priority} === 'High' ? 'Error' : ${priority} === 'Medium' ? 'Warning' : 'Success'}"/>
                                    </firstStatus>
                                    <attributes>
                                        <ObjectAttribute text="{accountName}"/>
                                    </attributes>
                                </ObjectListItem>
                            </List>
                        </f:content>
                    </f:Card>

                    <!-- Trending Products -->
                    <f:Card class="dashboardCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>trendingProductsTitle}"
                                subtitle="{i18n>trendingProductsSubtitle}"
                                iconSrc="sap-icon://product"/>
                        </f:header>
                        <f:content>
                            <List
                                id="trendingProductsList"
                                items="{path: '/TrendingProducts', length: 5}"
                                mode="None"
                                showSeparators="Inner">
                                <ObjectListItem
                                    title="{productName}"
                                    number="{trendScore}"
                                    numberUnit="Trend"
                                    numberState="Success"
                                    type="Active"
                                    press=".onProductPress">
                                    <firstStatus>
                                        <ObjectStatus
                                            text="{brand}"
                                            inverted="false"/>
                                    </firstStatus>
                                    <attributes>
                                        <ObjectAttribute text="RM {listPrice}"/>
                                    </attributes>
                                </ObjectListItem>
                            </List>
                        </f:content>
                    </f:Card>

                    <!-- Active Campaigns -->
                    <f:Card class="dashboardCard">
                        <f:header>
                            <f:cards.Header
                                title="{i18n>activeCampaignsTitle}"
                                subtitle="{i18n>activeCampaignsSubtitle}"
                                iconSrc="sap-icon://marketing-campaign"
                                statusText="{kpi>/campaignKPIs/activeCampaigns} active"/>
                        </f:header>
                        <f:content>
                            <List
                                id="activeCampaignsList"
                                items="{path: '/ActiveCampaigns', length: 5}"
                                mode="None"
                                showSeparators="Inner">
                                <ObjectListItem
                                    title="{campaignName}"
                                    number="RM {budget}"
                                    numberUnit="Budget"
                                    type="Active"
                                    press=".onCampaignPress">
                                    <firstStatus>
                                        <ObjectStatus
                                            text="{status}"
                                            state="{= ${status} === 'Active' ? 'Success' : 'Warning'}"
                                            inverted="true"/>
                                    </firstStatus>
                                    <attributes>
                                        <ObjectAttribute text="{campaignType}"/>
                                    </attributes>
                                </ObjectListItem>
                            </List>
                        </f:content>
                    </f:Card>

                </l:Grid>

            </VBox>
        </content>
    </Page>
</mvc:View>
